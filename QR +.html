<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bulk QR Generator — Robust</title>
<style>
  body{font-family:system-ui,Arial; background:#f4f7fb; margin:0; padding:24px; color:#111}
  .card{max-width:1000px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(12,20,40,.06)}
  h1{margin:0 0 10px;font-size:20px}
  textarea{width:100%;min-height:140px;border:1px solid #e2e8f0;border-radius:8px;padding:10px;font-size:14px;resize:vertical}
  .controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  button{border:0;padding:10px 14px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600}
  .btn-scan{background:#2563eb}.btn-download{background:#16a34a}.btn-clear{background:#ef4444}
  .note{color:#6b7280;font-size:13px;margin-bottom:8px}
  #list{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid #e6eef7}
  .row{display:grid;grid-template-columns:44px 1.3fr 1fr 1fr 120px 80px;gap:10px;align-items:center;padding:10px;border-bottom:1px solid #eef2f6}
  .row.head{background:#eef6ff;font-weight:700}
  .row:nth-child(odd):not(.head){background:#fbfdff}
  .idx{justify-self:center;color:#475569}
  input{padding:8px;border-radius:8px;border:1px solid #e6eef7;font-size:13px}
  .qr{width:100px;height:100px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#fff;border:1px dashed #e6eef7}
  .small{font-size:12px;color:#64748b}
  .actions button{background:transparent;border:0;cursor:pointer;font-size:18px}
  .status{margin-top:10px;font-size:13px;color:#334155}
  @media (max-width:820px){
    .row{grid-template-columns:28px 1fr 1fr 1fr}
    .qr,.actions{display:none}
  }
</style>
</head>
<body>
  <div class="card">
    <h1>Bulk Candidate QR Generator — Robust</h1>
    <div class="note">Paste your entire text (each candidate on its own line). The script will try to auto-detect candidate name and reservation id. Passport stays empty for manual input.</div>

    <textarea id="bulk" placeholder='Example line:
"Candidate Name 1"    "NID........."    "RES12345"    "Again occupation name"   Pending   Start Practical'></textarea>

    <div class="controls">
      <button id="scanBtn" class="btn-scan">Scan</button>
      <button id="dlAllBtn" class="btn-download">Download All QR Codes</button>
      <button id="clearBtn" class="btn-clear">Clear List</button>
      <div style="margin-left:auto" class="small">Uses <b>api.qrserver.com</b> for generation (no external JS lib required).</div>
    </div>

    <div id="list" aria-live="polite"></div>

    <div class="status" id="status">Status: ready</div>
  </div>

<script>
const bulk = document.getElementById('bulk');
const list = document.getElementById('list');
const status = document.getElementById('status');

document.getElementById('scanBtn').addEventListener('click', scanText);
document.getElementById('dlAllBtn').addEventListener('click', downloadAll);
document.getElementById('clearBtn').addEventListener('click', ()=>{ list.innerHTML=''; status.textContent='Status: cleared'; });

function scanText(){
  const raw = bulk.value || '';
  const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  list.innerHTML = '';

  // header row
  const h = document.createElement('div');
  h.className = 'row head';
  h.innerHTML = `<div class="idx">#</div><div>Candidate Name</div><div>Passport</div><div>Reservation ID</div><div>QR Preview</div><div>Actions</div>`;
  list.appendChild(h);

  let count = 0;
  for (const line of lines){
    // Skip obvious header lines
    if (/^occupation\s*name|^pending|^start practical/i.test(line)) continue;

    const extracted = extractFromLine(line);
    // if both name & reservation missing try looser extraction
    if (!extracted.name && !extracted.reservation) {
      // try splitting by tabs/spaces and take first & last-ish
      const parts = line.split(/\t+/).map(s=>s.trim()).filter(Boolean);
      if (parts.length >= 2){
        extracted.name = extracted.name || parts[0].replace(/^"|"$/g,'');
        extracted.reservation = extracted.reservation || parts[parts.length-1].replace(/^"|"$/g,'');
      }
    }

    if (!extracted.name && !extracted.reservation) {
      // push a disabled row to let user see skipped line
      const r = document.createElement('div');
      r.className = 'row';
      r.innerHTML = `<div class="idx">–</div><div colspan=5 style="color:#ef4444">Skipped line (no usable data): ${escapeHtml(line)}</div>`;
      list.appendChild(r);
      continue;
    }

    count++;
    addRow(count, extracted.name || '', extracted.reservation || '');
  }

  status.textContent = `Status: scanned ${count} entries (see list).`;
}

// Try to extract name & reservation id from a single line
function extractFromLine(line){
  const res = {name:'', reservation:''};

  // 1) quoted tokens
  const quoted = [...line.matchAll(/"([^"]+)"/g)].map(m=>m[1].trim()).filter(Boolean);

  if (quoted.length>=1) res.name = quoted[0];

  // If there are many quoted tokens, the reservation often sits in token index 2 or last
  if (quoted.length >= 3){
    // pick the token that looks like an ID (alphanumeric length >=4 and not NID label)
    const candidate = quoted.find((t,i)=>/([A-Z0-9\-]{4,})/i.test(t) && !/nid|national id/i.test(t));
    if (candidate) res.reservation = candidate;
    else res.reservation = quoted[2];
  } else if (quoted.length === 2) {
    // second might be NID; so try to find reservation elsewhere in line
    // we'll search full line for other patterns below
  }

  // 2) try explicit phrases like "Reservation ID 12345" or Reservation: 12345
  if (!res.reservation){
    const m = line.match(/reservation\s*(?:id)?\s*[:\-\s]*([A-Z0-9\-]{4,})/i);
    if (m) res.reservation = m[1].trim();
  }

  // 3) fallback: any long alphanumeric token (prefer tokens not including 'NID' or long numeric NID-like)
  if (!res.reservation){
    const al = [...line.matchAll(/\b([A-Z0-9\-]{4,})\b/ig)].map(m=>m[1]);
    if (al.length){
      // remove tokens that look like "NID", or pure long digit sequences longer than 12 (likely national id)
      const filtered = al.filter(t => !/^\d{10,}$/.test(t) && !/nid/i.test(t));
      res.reservation = (filtered.length? filtered[filtered.length-1] : al[al.length-1]) || '';
    }
  }

  // 4) if name still empty, attempt to find first proper-name-like quoted or before first NID
  if (!res.name){
    // look for capitalized name sequences inside line (loose)
    const m2 = line.match(/"([A-Za-z ]{3,})"/);
    if (m2) res.name = m2[1].trim();
    else {
      // split by tabs/spaces and take first chunk excluding words like occupation/nid/reservation
      const parts = line.split(/\t+/).map(s=>s.trim()).filter(Boolean);
      if (parts.length) {
        // pick first part that is not header-like
        const maybe = parts.find(p => !/occupation|reservation|nid|pending|start/i.test(p));
        res.name = maybe || parts[0];
      }
    }
  }

  // Trim and remove trailing labels
  if (res.name) res.name = res.name.replace(/\b(NID|Reservation|ID|Pending|Start Practical)\b/ig,'').trim();
  if (res.reservation) res.reservation = res.reservation.replace(/\b(Reservation|ID)\b/ig,'').trim();

  return res;
}

// Add a row to the UI
function addRow(idx, name, reservation){
  const r = document.createElement('div');
  r.className = 'row';
  r.innerHTML = `
    <div class="idx">${idx}</div>
    <input class="nm" value="${escapeHtml(name)}" />
    <input class="pp" value="" placeholder="Passport (manual)" />
    <input class="rs" value="${escapeHtml(reservation)}" />
    <div class="qr" aria-hidden="true"></div>
    <div class="actions"><button title="Remove" class="rm">✕</button></div>
  `;
  list.appendChild(r);

  const nm = r.querySelector('.nm');
  const pp = r.querySelector('.pp');
  const rs = r.querySelector('.rs');
  const qdiv = r.querySelector('.qr');
  r.querySelector('.rm').addEventListener('click', ()=>r.remove());
  [nm,pp,rs].forEach(i => i.addEventListener('input', ()=>renderPreview(r)));

  renderPreview(r);
}

function renderPreview(row){
  const name = row.querySelector('.nm').value.trim();
  const pass = row.querySelector('.pp').value.trim();
  const resv = row.querySelector('.rs').value.trim();
  const qdiv = row.querySelector('.qr');
  qdiv.innerHTML = '';
  if (!name || !resv) return;

  const content = `Candidate Name : ${name}\nPassport Number : ${pass}\nReservation ID : ${resv}`;
  const url = makeQRUrl(content, 100);
  const img = new Image();
  img.alt = 'QR';
  img.src = url;
  img.style.maxWidth = '100%';
  img.style.maxHeight = '100%';
  img.onload = ()=>{ qdiv.innerHTML=''; qdiv.appendChild(img); };
  img.onerror = ()=>{ qdiv.innerHTML = '<div class="small">QR preview failed</div>'; };
}

// Build QR image URL using api.qrserver.com
function makeQRUrl(data, size=200){
  return 'https://api.qrserver.com/v1/create-qr-code/?size=' + encodeURIComponent(size + 'x' + size) + '&data=' + encodeURIComponent(data);
}

// Download all rows sequentially
async function downloadAll(){
  status.textContent = 'Status: starting download...';
  const rows = Array.from(list.querySelectorAll('.row')).filter(r => !r.classList.contains('head'));
  if (!rows.length){ alert('Nothing to download — please Scan first.'); status.textContent='Status: no rows'; return; }

  // disable controls visually
  toggleControls(true);
  for (let i=0;i<rows.length;i++){
    const row = rows[i];
    const name = row.querySelector('.nm').value.trim() || ('QR_' + (i+1));
    const pass = row.querySelector('.pp').value.trim();
    const resv = row.querySelector('.rs').value.trim();

    // optional: basic passport validation prompt if partially filled
    if (pass && !/^\d{6,20}$/.test(pass)){ // allow variable lengths
      // allow user to continue — we won't block, but note it
      console.warn('Passport may look irregular for', name);
    }

    const content = `Candidate Name : ${name}\nPassport Number : ${pass}\nReservation ID : ${resv}`;
    const url = makeQRUrl(content, 400);

    status.textContent = `Status: downloading ${i+1}/${rows.length} — ${name}`;
    try {
      // fetch image as blob and save
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Network error ' + resp.status);
      const blob = await resp.blob();
      const a = document.createElement('a');
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = safeFileName(name) + '.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(objectUrl);
      // small pause to avoid browser blocking multiple downloads
      await sleep(250);
    } catch (err){
      console.error('Failed to download QR for', name, err);
      alert('Failed to download QR for: ' + name + '\nError: ' + (err.message || err));
    }
  }
  toggleControls(false);
  status.textContent = 'Status: done';
}

function toggleControls(disable){
  document.getElementById('scanBtn').disabled = disable;
  document.getElementById('dlAllBtn').disabled = disable;
  document.getElementById('clearBtn').disabled = disable;
  const buttons = document.querySelectorAll('button');
  buttons.forEach(b => b.style.opacity = disable ? 0.6 : 1);
}

function safeFileName(s){ return (s||'QR').replace(/[\\\/:*?"<>|]+/g,'_').trim().slice(0,120) || 'QR'; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>
